<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Repaired Liquid Glass Effect</title>
  <style>
    body, html {
      background-image: url('https://images.unsplash.com/photo-1553095066-5014bc7b7f2d?q=80&w=2787&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
    }

    #controls {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      display: inline-flex;
      flex-direction: column;
      padding: 16px;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
      font-family: sans-serif;
      z-index: 10000;
    }

    #controls label {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    #controls input[type=range] {
      width: 200px;
      margin-right: 10px;
    }

    /* * --- FIX & IMPROVEMENTS ---
     * 1. Added a semi-transparent background-color. This is ESSENTIAL for backdrop-filter to be visible.
     * 2. Added a subtle border to better define the "glass" edge.
     * 3. Added -webkit-backdrop-filter for Safari compatibility.
    */
    #preview {
      backdrop-filter: url(#displacementFilter4);
      -webkit-backdrop-filter: url(#displacementFilter4);
      background-color: rgba(255, 255, 255, 0.1); /* CRITICAL FIX */
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 25px; /* Match the corner radius from the filter */
      pointer-events: none;
      box-shadow: 0 8px 32px 0 rgba(0,0,0,0.3); /* Optional: add a subtle shadow for depth */
    }

    #draggable {
      position: absolute;
      z-index: 9999;
      top: -1150px;
      left: -1150px;
      resize: both;
      min-width: 1200px;
      min-height: 1200px;
      overflow: hidden;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
      clip-path: polygon(calc(100% - 120px) calc(100% - 120px), calc(100% - 120px) 100%, 100% 100%, 100% calc(100% - 120px));
      cursor: move;
    }

  </style>
</head>
<body>

<div style="position:absolute;top:-9999px;left:-9999px;width:0;height:0">
  <svg
          id="effectSvg"
          width="200"
          height="200"
          viewBox="0 0 200 200"
          xmlns="http://www.w3.org/2000/svg"
          xmlns:xlink="http://www.w3.org/1999/xlink">

    <filter id="displacementFilter4">
      <feImage xlink:href="data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='%230001' /%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='%23FFF' style='filter:blur(5px)' /%3E%3C/svg%3E" x="0%" y="0%" width="100%" height="100%" result="thing9" id="thing9" />
      <feImage xlink:href="data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='%23FFF1' style='filter:blur(15px)' /%3E%3C/svg%3E" x="0%" y="0%" width="100%" height="100%" result="thing0" id="thing0" />
      <feImage xlink:href="data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='%23000' /%3E%3C/svg%3E" x="0%" y="0%" width="100%" height="100%" result="thing1" id="thing1" />
      <feImage xlink:href="data:image/svg+xml,%3Csvg width='200' height='200' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='gradient1' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%23000'/%3E%3Cstop offset='100%25' stop-color='%2300F'/%3E%3C/linearGradient%3E%3ClinearGradient id='gradient2' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23000'/%3E%3Cstop offset='100%25' stop-color='%230F0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='200' height='200' rx='25' fill='%237F7F7F' /%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='%23000' /%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='url(%23gradient1)' style='mix-blend-mode: screen' /%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='url(%23gradient2)' style='mix-blend-mode: screen' /%3E%3Crect x='50' y='50' width='100' height='100' rx='25' fill='%237F7F7FBB' style='filter:blur(5px)' /%3E%3C/svg%3E" x="0%" y="0%" width="100%" height="100%" result="thing2" id="thing2" />
      <feGaussianBlur stdDeviation="0.7" id="preblur" in="SourceGraphic" result="preblur" />
      <feDisplacementMap
              id="dispR"
              in2="thing2"
              in="preblur"
              scale="-148"
              xChannelSelector="B"
              yChannelSelector="G"
              result="dispR_map"
      />
      <feColorMatrix
              in="dispR_map"
              type="matrix"
              values="1 0 0 0 0
              0 0 0 0 0
              0 0 0 0 0
              0 0 0 1 0"  result="disp1" />
      <feDisplacementMap
              id="dispG"
              in2="thing2"
              in="preblur"
              scale="-150"
              xChannelSelector="B"
              yChannelSelector="G"
              result="dispG_map"
      />
      <feColorMatrix
              in="dispG_map"
              type="matrix"
              values="0 0 0 0 0
              0 1 0 0 0
              0 0 0 0 0
              0 0 0 1 0"  result="disp2" />
      <feDisplacementMap
              id="dispB"
              in2="thing2"
              in="preblur"
              scale="-152"
              xChannelSelector="B"
              yChannelSelector="G"
              result="dispB_map"
      />
      <feColorMatrix
              in="dispB_map"
              type="matrix"
              values="0 0 0 0 0
              0 0 0 0 0
              0 0 1 0 0
              0 0 0 1 0"  result="disp3" />
      <feBlend  in="disp1" in2="disp2" mode="screen" result="blended1"/>
      <feBlend  in="blended1" in2="disp3" mode="screen" result="blended_colors"/>
      <feGaussianBlur in="blended_colors" stdDeviation="0.0" id="postblur" result="post_blur" />
      <feBlend  in="post_blur" in2="thing0" mode="screen"/>
      <feBlend  in2="thing9" mode="multiply"/>
      <feComposite in2="thing1" operator="in"/>
      <feOffset dx="43" dy="43"/>
    </filter>
  </svg>
</div>

<div id="draggable">
  <div id="preview"></div>
</div>

<div id="controls">
  <label><input type="range" id="w" value="200" min="10" max="1000">Width</label>
  <label><input type="range" id="h" value="200" min="10" max="1000">Height</label>
  <label><input type="range" id="r" value="25" min="0" max="255">Corner Radius</label>
  <label><input type="range" id="d1" value="17" min="0" max="255">Darkness Opacity</label>
  <label><input type="range" id="d2" value="5" min="0" max="50">Darkness Blur</label>
  <label><input type="range" id="l1" value="17" min="0" max="255">Lightness Opacity</label>
  <label><input type="range" id="l2" value="15" min="0" max="50">Lightness Blur</label>
  <label><input type="range" id="c1" value="68" min="0" max="255">Center Distortion</label>
  <label><input type="range" id="c2" value="15" min="0" max="20">Center Size</label>
  <label><input type="range" id="b1" value="7" min="0" max="100">Pre-blur</label>
  <label><input type="range" id="b2" value="0" min="0" max="100">Post-blur</label>
  <label><input type="range" id="c4" value="20" min="0" max="100">Iridescence</label>
</div>

<script>
  const draggable = document.getElementById("draggable");
  const preview = document.getElementById("preview");

  const effectSvg = document.getElementById("effectSvg");
  const thing9 = document.getElementById("thing9");
  const thing0 = document.getElementById("thing0");
  const thing1 = document.getElementById("thing1");
  const thing2 = document.getElementById("thing2");
  const preblur = document.getElementById("preblur");
  const postblur = document.getElementById("postblur");
  const dispR = document.getElementById("dispR");
  const dispG = document.getElementById("dispG");
  const dispB = document.getElementById("dispB");

  function updateSettings() {
    const vals = {};
    document.querySelectorAll("#controls input").forEach(e => vals[e.id] = parseFloat(e.value));

    const w = vals.w;
    const h = vals.h;

    effectSvg.setAttribute("width", `${w}`);
    effectSvg.setAttribute("height", `${h}`);
    effectSvg.setAttribute("viewBox", `0 0 ${w} ${h}`);

    preview.style.width = `${w+50}px`;
    preview.style.height = `${h+50}px`;
    preview.style.translate = `${w/4}px ${h/4}px`;
    preview.style.borderRadius = `${vals.r}px`;

    draggable.style.top = `${-1200+h/4}px`;
    draggable.style.left = `${-1200+w/4}px`;
    draggable.style.clipPath = `polygon(calc(100% - ${w/2+25}px) calc(100% - ${h/2+25}px), calc(100% - ${w/2+25}px) 100%, 100% 100%, 100% calc(100% - ${h/2+25}px))`;

    thing9.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', `data:image/svg+xml,%3Csvg width='${w}' height='${h}' viewBox='0 0 ${w} ${h}' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='rgb%280 0 0 %2F${vals.d1/2.55}%25%29' /%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='%23FFF' style='filter:blur(${vals.d2}px)' /%3E%3C/svg%3E`);
    thing0.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', `data:image/svg+xml,%3Csvg width='${w}' height='${h}' viewBox='0 0 ${w} ${h}' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='rgb%28255 255 255 %2F${vals.l1/2.55}%25%29' style='filter:blur(${vals.l2}px)' /%3E%3C/svg%3E`);
    thing1.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', `data:image/svg+xml,%3Csvg width='${w}' height='${h}' viewBox='0 0 ${w} ${h}' xmlns='http://www.w3.org/2000/svg'%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='%23000' /%3E%3C/svg%3E`);
    thing2.setAttributeNS('http://www.w3.org/1999/xlink', 'xlink:href', `data:image/svg+xml,%3Csvg width='${w}' height='${h}' viewBox='0 0 ${w} ${h}' xmlns='http://www.w3.org/2000/svg'%3E%3Cdefs%3E%3ClinearGradient id='gradient1' x1='0%25' y1='0%25' x2='100%25' y2='0%25'%3E%3Cstop offset='0%25' stop-color='%23000'/%3E%3Cstop offset='100%25' stop-color='%2300F'/%3E%3C/linearGradient%3E%3ClinearGradient id='gradient2' x1='0%25' y1='0%25' x2='0%25' y2='100%25'%3E%3Cstop offset='0%25' stop-color='%23000'/%3E%3Cstop offset='100%25' stop-color='%230F0'/%3E%3C/linearGradient%3E%3C/defs%3E%3Crect x='0' y='0' width='${w}' height='${h}' rx='${vals.r}' fill='%237F7F7F' /%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='%23000' /%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='url(%23gradient1)' style='mix-blend-mode: screen' /%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='url(%23gradient2)' style='mix-blend-mode: screen' /%3E%3Crect x='${w/4}' y='${h/4}' width='${w/2}' height='${h/2}' rx='${vals.r}' fill='rgb%28127 127 127 %2F${(255-vals.c1)/2.55}%25%29' style='filter:blur(${20-vals.c2}px)' /%3E%3C/svg%3E`);

    preblur.setAttribute("stdDeviation", `${vals.b1/10}`);
    postblur.setAttribute("stdDeviation", `${vals.b2/10}`);

    const baseDisplacement = -150;
    // --- ENHANCEMENT ---
    // Increased the multiplier from /10 to /2 to make the effect more pronounced
    const dispersion = vals.c4 / 2;

    dispR.setAttribute("scale", `${baseDisplacement + dispersion}`);
    dispG.setAttribute("scale", `${baseDisplacement}`);
    dispB.setAttribute("scale", `${baseDisplacement - dispersion}`);
  }

  document.querySelectorAll("#controls input").forEach(e => e.oninput = updateSettings);

  // Initial call to set everything up
  updateSettings();

  // Make the preview draggable
  let isDragging = false;
  let offsetX, offsetY;

  draggable.addEventListener('mousedown', (e) => {
    isDragging = true;
    offsetX = e.clientX - draggable.offsetLeft;
    offsetY = e.clientY - draggable.offsetTop;
    draggable.style.cursor = 'grabbing';
  });

  document.addEventListener('mousemove', (e) => {
    if (isDragging) {
      draggable.style.left = `${e.clientX - offsetX}px`;
      draggable.style.top = `${e.clientY - offsetY}px`;
    }
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    draggable.style.cursor = 'move';
  });

</script>

</body>
</html>